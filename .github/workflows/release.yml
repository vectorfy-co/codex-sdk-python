name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.80.0)"
        required: false
      prerelease:
        description: "Mark as prerelease"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Resolve tag
        id: resolve
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract changelog section
        env:
          TAG: ${{ steps.resolve.outputs.tag }}
        run: |
          python - <<'PY'
          import os
          import re
          import sys

          tag = os.environ["TAG"]
          version = tag[1:] if tag.startswith("v") else tag
          path = "CHANGELOG_SDK.md"
          with open(path, "r", encoding="utf-8") as handle:
            text = handle.read()

          def extract_section(match_obj):
            start = match_obj.start()
            remainder = text[match_obj.end():]
            next_header = re.search(r"^##\\s+\\S+.*$", remainder, re.MULTILINE)
            end = match_obj.end() + (next_header.start() if next_header else len(remainder))
            return text[start:end].strip()

          header_pattern = re.compile(rf"^##\\s+v?{re.escape(version)}\\b.*$", re.MULTILINE)
          match = header_pattern.search(text)
          if match:
            body = extract_section(match)
          else:
            first_header = re.search(r"^##\\s+\\S+.*$", text, re.MULTILINE)
            if not first_header:
              print(f"::error::No changelog sections found in {path}")
              sys.exit(1)
            print(
              f"::warning::Version {version} not found in {path}; "
              "using the latest changelog section instead."
            )
            body = extract_section(first_header)

          with open("release_notes.md", "w", encoding="utf-8") as handle:
            handle.write(body + "\n")
          PY

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve.outputs.tag }}
          name: ${{ steps.resolve.outputs.tag }}
          body_path: release_notes.md
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
